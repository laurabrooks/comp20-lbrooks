<!DOCTYPE html>

<html>

<head>
	<title>Marauder's Map</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script src="http://maps.google.com/maps/api/js?sensor=true"></script>
	<link rel="stylesheet" href="mmap_style.css" />

	<script>

	var myLat = 0;
	var myLng = 0;
	var request = new XMLHttpRequest();
	var me = new google.maps.LatLng(myLat, myLng);
	var mapOptions = {
		center: me,
		zoom: 15
	}
	var pizza = "icon.jpg";
	var otherPeople;


	function init() {
		//console.log("in init");
		map = new google.maps.Map(document.getElementById("mmap_canvas"), mapOptions);
		getMyLocation();
	}

	function getMyLocation() {
		//console.log("in getMyLocation");
		if (navigator.geolocation) { 
			//console.log("in if statement in getMyLocation");
			navigator.geolocation.getCurrentPosition(function(position) {
				myLat = position.coords.latitude;
				myLng = position.coords.longitude;
				//console.log(myLat, myLng);
				renderMap();
			});
		}
		else {
			alert("Sorry! Geolocation is not supported in your browser.");
		}
	}


	function renderMap() {
		//console.log("in renderMap");
		me = new google.maps.LatLng(myLat, myLng);
		map.panTo(me);
		//I used this code from google developers tutorial
		myMarker = new google.maps.Marker({
			position: me,
			map: map,
			title: "Cheri Vasquez",
			icon: pizza
		});

		markerInfo = new google.maps.InfoWindow({
		content: "<p>Cheri Vasquez</p>",
		});

		google.maps.event.addListener(myMarker, 'click', function(){
			markerInfo.open(map, myMarker);
		});

		myMarker.setMap(map);

		getOtherPeople();
	}

	function getOtherPeople(){
		//Marcy Regalado explained to me how to use parameters for request.send
		param = "login=CheriVasquez&lat=" + myLat + "&lng=" + myLng;
		//console.log("before request");
		
		url = "https://secret-about-box.herokuapp.com/sendLocation";
		//console.log("before POST");
		request.open("POST", url, true);
		request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

		request.onreadystatechange = function(){
		console.log("inside onreadystate function")
			if (request.readyState == 4 && request.status == 200){
				otherPeople = JSON.parse(request.responseText);
				parse(otherPeople);
				
			console.log("Inside if statement inside onreadystate");
			}
		}
		request.send(param);
	}

	function parse(otherPeople){
		for (i=0; i<otherPeople.length; i++){
			//Inside here I have to create markers for every person
			//include: name and distance (miles)
			if (otherPeople[i].login == "CheriVasquez"){
				console.log("FOUnd me");
			}
		}
	}

	</script>
</head>

<body onload="init()">
	<div id="mmap_canvas">
	</div>
</body>
</html>
