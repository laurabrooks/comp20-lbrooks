<!DOCTYPE html>

<html>

<head>
	<title>Marauder's Map</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script src="http://maps.google.com/maps/api/js?sensor=true"></script>
	<link rel="stylesheet" href="mmap_style.css" />

	<script>

	var myLat = 0;
	var myLng = 0;
	var request = new XMLHttpRequest();
	var me = new google.maps.LatLng(myLat, myLng);
	var mapOptions = {
		center: me,
		zoom: 15
	}
	var pizza = "icon.jpg";
	var otherPeople;


	function init() {	
		map = new google.maps.Map(document.getElementById("mmap_canvas"), mapOptions);
		getMyLocation();
	}

	function getMyLocation() {
		if (navigator.geolocation) { 
			navigator.geolocation.getCurrentPosition(function(position) {
				myLat = position.coords.latitude;
				myLng = position.coords.longitude;
				renderMap();
			});
		}

		else {
			alert("Sorry! Geolocation is not supported in your browser.");
		}
	}


	//this code is based on the code in the google developers tutorial for the maps API
	function renderMap() {
		
		me = new google.maps.LatLng(myLat, myLng);
		map.panTo(me);

		myMarker = new google.maps.Marker({
			position: me,
			map: map,
			title: "Cheri Vasquez",
			icon: pizza
		});

		markerInfo = new google.maps.InfoWindow({
		content: "<p>Cheri Vasquez</p>",
		});

		google.maps.event.addListener(myMarker, 'click', function(){
			markerInfo.open(map, myMarker);
		});

		myMarker.setMap(map);

		getOtherPeople();
	}

	function getOtherPeople(){
		//Marcy Regalado explained to me how to use parameters for request.send
		param = "login=CheriVasquez&lat=" + myLat + "&lng=" + myLng;
		
		url = "https://secret-about-box.herokuapp.com/sendLocation";
		request.open("POST", url, true);
		request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

		request.onreadystatechange = function(){
			if (request.readyState == 4 && request.status == 200){
				otherPeople = JSON.parse(request.responseText);
				parse(otherPeople);
			}
		}

		request.send(param);
	}

	function parse(otherPeople){

		for (i = 0; i < otherPeople.length; i++){
			if (otherPeople[i].login != "CheriVasquez"){

				theirLat = otherPeople[i].lat;
				theirLng = otherPeople[i].lng;
				theirLogin = otherPeople[i].login;
				
				theirMarkers(theirLat, theirLng, theirLogin);
			}
		}
	}

	function theirMarkers(theirLat, theirLng, theirLogin){
		pos = new google.maps.LatLng(theirLat, theirLng);

		marker = new google.maps.Marker ({
			position: pos,
			map: map,
			title: theirLogin;
		});

		theirMarkerInfo = new google.maps.InfoWindow({
			content: "<p>" + theirLogin + "</p>" //HAVE TO ALSO INCLUDE DISTANCE
		});

		google.maps.event.addEventListener(marker, 'click', function(){
			theirMarkerInfo.open(map, marker);
		});
		
		marker.setMap(map);
	}

	</script>
</head>

<body onload="init()">
	<div id="mmap_canvas">
	</div>
</body>
</html>
